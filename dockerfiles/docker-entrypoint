#!/bin/bash
set -euo pipefail

# Ensure PATH includes user's local bin directory
# This will be substituted with actual username during build
export PATH="/home/DOCKERUSER/.local/bin:$PATH"

# Also set PATH for runuser commands
export RUNUSER_PATH="/home/DOCKERUSER/.local/bin:$PATH"

ENABLE_SUDO=false
DISABLE_FIREWALL=false
new_args=()
while [[ $# -gt 0 ]]; do
    case "$1" in
        --enable-sudo) ENABLE_SUDO=true; shift ;;
        --disable-firewall) DISABLE_FIREWALL=true; shift ;;
	--claude-flow) ENABLE_CLAUDE_FLOW=true; shift ;;
        *) new_args+=("$1"); shift ;;
    esac
done
if [[ ${#new_args[@]} -gt 0 ]]; then
    set -- "${new_args[@]}"
else
    set --
fi
export DISABLE_FIREWALL

if [[ "${ENABLE_CLAUDE_FLOW:-false}" == "true" ]]; then
  export ENABLE_CLAUDE_FLOW
  CLAUDE_CODE="claude --dangerously-skip-permissions && claude-flow init"
else
  CLAUDE_CODE="claude"
fi

# Restore Claude configuration if mounted
if [ -d "/tmp/claude-config" ]; then
    # Copy .claude folder if it exists
    if [ -d "/tmp/claude-config/.claude" ]; then
        cp -r "/tmp/claude-config/.claude" "/home/DOCKERUSER/"
        chown -R DOCKERUSER:DOCKERUSER "/home/DOCKERUSER/.claude"
    fi
    
    # Copy .claude.json if it exists
    if [ -f "/tmp/claude-config/.claude.json" ]; then
        cp "/tmp/claude-config/.claude.json" "/home/DOCKERUSER/"
        chown DOCKERUSER:DOCKERUSER "/home/DOCKERUSER/.claude.json"
    fi
fi

if [ -f /home/DOCKERUSER/init-firewall ]; then
    sudo /home/DOCKERUSER/init-firewall || true
fi

# Handle sudo access based on --enable-sudo flag
# Note: DOCKERUSER user already has sudoers entry from Dockerfile
if [ "$ENABLE_SUDO" != "true" ]; then
    # Remove sudo access if --enable-sudo wasn't passed
    sudo rm -f /etc/sudoers.d/DOCKERUSER
fi

cd /home/DOCKERUSER

if [[ $# -eq 0 ]]; then
  exec runuser -u DOCKERUSER -- bash -c "source /home/DOCKERUSER/.nvm/nvm.sh && cd /workspace && exec tmux new-session ${CLAUDE_CODE}"
else
  exec runuser -u DOCKERUSER -- bash -c "source /home/DOCKERUSER/.nvm/nvm.sh && cd /workspace && $*"
fi